# Story Generation Tasks Configuration
# Tasks for novel generation with romance and mystery genres

# ==================== INITIALIZATION PHASE TASKS ====================

build_story_spec:
  description: >
    根据用户输入的题材（genre: {genre}）和主题句（theme_statement: {theme_statement}），
    首先生成一个吸引人的小说名称（2-8个中文字符），然后创建完整的故事规格（StorySpec）和风格指南（StyleGuide）。

    **⚠️ JSON 格式强制约束（输出前必须自检）**
    1. 所有键名（property names）必须用双引号包围
       ❌ 错误：{key: "value"} 或 {key: "value",}
       ✅ 正确：{"key": "value"}
    2. 不要使用单引号
       ❌ 错误：{'key': 'value'}
       ✅ 正确：{"key": "value"}
    3. 不要有尾随逗号
       ❌ 错误：{"key": "value",}
       ✅ 正确：{"key": "value"}
    4. 确保所有花括号和方括号都正确闭合
    5. 不要使用省略号或缩写表示继续

    用户可能还提供了其他偏好：{additional_preferences}

    **第一步：生成小说名称**
    - 根据{genre}题材和{theme_statement}主题
    - 生成一个简短、吸引人、符合题材特点的小说名称
    - 名称长度：2-8个中文字符
    - 爱情题材示例：《心动时刻》、《错位的我们》、《职场迷情》
    - 悬疑题材示例：《迷雾背后》、《最后一名证人》、《消失的档案》
    - 避免过于俗套的名称，要有一定文学性或悬念感

    **第二步：创建StorySpec**
    1. 确定题材是"romance"（都市职场爱情）还是"mystery"（本格/社会派悬疑）
    2. 设置叙事视角为第三人称
    3. 总章数：9章，每章目标3000字（允许±10%）
    4. 语言：中文
    5. 基调：现实、直白、有张力
    6. 禁忌：未成年人性内容、过度血腥细节、仇恨/歧视性表达
    7. 必须包含：章末钩子、每章信息增量、每章情绪转折

    对于爱情题材额外设置：
    - relationship_arc: 从陌生/互斥 → 接近 → 绑定 → 破裂 → 选择/牺牲 → 终局
    - emotional_turns_per_chapter: 1

    对于悬疑题材额外设置：
    - mystery_question: 一句话概括核心谜题
    - clue_budget_rule: 每章至少1条可见线索入库
    - fair_play_rule: 终局解答所用关键线索必须在前文出现

    **输出格式要求（严格遵守）：**

    输出必须是严格的JSON格式，首先包含novel_name字段，然后是完整的StorySpec对象。

    **⚠️ 重要JSON格式要求（必须遵守）：**
    1. 所有键名（property names）必须用双引号包围
    2. ❌ 错误示例：`chapter_word_tolerance: 0.1`
    3. ✅ 正确示例：`"chapter_word_tolerance": 0.1`
    4. ❌ 错误示例：`{prop: "value"}`
    5. ✅ 正确示例：`{"prop": "value"}`
    6. 确保JSON完全符合标准格式，可以使用JSON验证器检查
    7. 不要包含JSON之外的任何文字说明

    **🔥 关键：必须生成完整的JSON！**
    - 绝对不要在生成过程中停止！
    - 必须确保story_spec对象完整，包含所有必需字段
    - 必须正确闭合所有花括号和方括号
    - 在输出之前，检查JSON是否完整且格式正确
    - 完整的JSON结构示例见下文的"预期输出"部分

    **🚨 绝对禁止的错误（会导致JSON解析失败）：**
    - ❌ 不要使用Python字典语法：`{key: value}`（缺少引号）
    - ❌ 不要使用单引号：`{'key': 'value'}`（必须是双引号）
    - ❌ 不要有尾随逗号：`{"key": "value",}`（最后一个元素后不能有逗号）
    - ❌ 不要使用省略号或缩写：不要用`...`表示继续
    - ❌ 不要添加注释：JSON不支持注释
    - ❌ 不要使用markdown代码块：不要用\`\`\`json...\`\`\`包裹
    - ✅ 必须使用纯JSON格式：`{"key": "value"}`（双引号，无尾随逗号，无注释）
    - ✅ 直接从第一个`{`开始，到最后一个`}`结束，中间没有任何其他文字

  expected_output: >
    严格JSON格式（所有键名必须用双引号包围），包含两个字段：

    {
      "novel_name": "小说名称（2-8个中文字符）",
      "story_spec": {
        "language": "zh",
        "genre": "romance"或"mystery",
        "subgenre": "urban_workplace"等,
        "total_chapters": 9,
        "target_words_per_chapter": 3000,
        "chapter_word_tolerance": 0.1,
        "narration": {"pov": "third_person", "tense": "past_or_present_consistent"},
        "style": {
          "language": "zh",
          "tone": ["现实", "细腻", "有张力"],
          "pacing": "balanced",
          "imagery_density": "light",
          "dialogue_ratio": 0.3,
          "forbidden_words": [],
          "style_notes": []
        },
        "taboos": ["未成年人性内容", "过度血腥细节", "仇恨/歧视性表达"],
        "must_have": ["章末钩子", "每章信息增量", "每章情绪转折"],
        "theme_statement": "{theme_statement}",
        "ending_contract": "结局必须兑现主题句的价值判断或反讽",
        "relationship_arc": "...",
        "emotional_turns_per_chapter": 1
      }
    }

    ⚠️ 注意：上面的JSON示例是完整结构，确保你的输出也完整包含所有字段！
    ⚠️ 直接输出JSON对象，从{开始，到}结束，不要使用markdown代码块！
    不要包含任何JSON之外的文字说明。
  agent: theme_interpreter

build_concept:
  description: >
    基于StorySpec创建人物概念和关系网络。

    **⚠️ 完整性要求（最高优先级 - 必须严格遵守）**
    - 必须一次性生成完整的Concept对象，不能中途停止或截断
    - 必须包含所有必需字段：characters, relationships, core_conflict
    - 必须包含题材特定字段：workplace_ecosystem (爱情) 或 suspect_pool (悬疑)
    - characters数组必须包含所有人物（爱情：2-3个，悬疑：主要人物）
    - relationships数组必须包含完整的关系网络
    - 绝对不能只生成部分人物或字段就结束

    **⚠️ 输出完整性检查清单（输出JSON前必须逐项确认）**
    在输出JSON前，请逐一检查：
    1. ✓ 包含characters数组（长度>0，爱情2-3个，悬疑根据需求）
    2. ✓ 包含relationships数组（长度>0）
    3. ✓ 包含core_conflict字段（非空字符串）
    4. ✓ 爱情题材包含workplace_ecosystem对象
    5. ✓ 悬疑题材包含suspect_pool对象
    6. ✓ 每个character都有完整字段（name, role, personality等）
    7. ✓ 所有花括号 { 和 } 正确配对（数量相等）
    8. ✓ 所有方括号 [ 和 ] 正确配对（数量相等）
    9. ✓ JSON可以完整解析，没有语法错误

    **⚠️ 防止提前终止的提示**
    - 如果你发现自己生成了部分人物或字段后"想停止"，请继续生成
    - 你的任务是生成完整的Concept对象，不是部分字段
    - 确保所有人物和关系都完整生成后再停止输出
    - 确保JSON的最后是完整的闭合括号 }

    **⚠️ JSON 格式强制约束（输出前必须自检）**
    1. 所有键名必须用双引号包围
    2. 不要使用单引号或尾随逗号
    3. 确保所有花括号和方括号都正确闭合

    **⚠️ 契约强约束（必须严格遵守，否则会触发Pydantic校验失败）**
    - characters.role 只能取以下枚举之一：
      "protagonist" | "antagonist" | "supporting" | "minor"
      ❌ 不要输出："主角"、"主要角色" 等中文或其他自由文本
    - relationships.relationship_type 只能取以下枚举之一：
      "romantic" | "professional" | "family" | "rival" | "friend" | "neutral"
    - 下列字段必须是 **扁平的字符串数组 List[string]**，禁止嵌套数组、禁止混入对象：
      personality, secrets, forbidden_phrases
      ❌ 错误示例： "secrets": ["秘密1", ["禁用短语A","禁用短语B"]]
      ✅ 正确示例： "secrets": ["秘密1", "秘密2"]

    题材：{genre}
    主题句：{theme_statement}
    StorySpec: {story_spec}

    对于爱情题材（都市职场）：
    1. 设计2-3个主要人物（主角、配角）
    2. 每个人物包含：name, role, age, occupation, personality (列表),
       motivation, secrets (列表), speech_pattern, forbidden_phrases, backstory, arc_description
    3. 设计人物关系（relationship_type, status, history, development_plan）
    4. 设计职场生态：公司/组织背景、角色职责、权力关系
    5. 设计情感阻碍机制：阶层差异/误会/价值观冲突/过往创伤

    对于悬疑题材（本格/社会派）：
    1. 设计主要人物（侦探、嫌疑人、受害者等）
    2. 设计嫌疑人池（3-5人，含动机和可疑点）
    3. 设计核心谜题（mystery_question）和真相草案（truth_solution）
    4. 设计动机链：每个嫌疑人的作案动机
    5. 设计误导点（red_herrings）：3-5个，必须可合理解释

    输出格式：
    {
      "characters": [人物对象列表],
      "relationships": [关系对象列表],
      "workplace_ecosystem": {...} (爱情) OR "suspect_pool": {...} (悬疑),
      "core_conflict": "...",
      "truth_card_draft": {...} (悬疑，仅内部使用)
    }
  expected_output: >
    严格JSON格式，包含characters数组、relationships数组、
    workplace_ecosystem (爱情) 或 suspect_pool (悬疑)、core_conflict。
    每个人物必须包含完整的字段。不要包含JSON之外的文字。
  agent: concept_designer

build_outline:
  description: >
    基于StorySpec和人物概念设计完整的三幕九章大纲。

    **⚠️ 完整性要求（最高优先级 - 必须严格遵守）**
    - 必须一次性生成完整的9章大纲，不能中途停止或截断
    - 在开始生成前，确认已理解需要输出全部9章
    - 在生成过程中，如果发现输出了前N章后停止，必须继续生成剩余章节
    - 生成完成前，请自检：是否包含了chapters[0]到chapters[8]（共9个）
    - 绝对不能只生成1-3章就结束，必须完成全部9章才能停止输出

    **⚠️ 输出完整性检查清单（输出JSON前必须逐项确认）**
    在输出JSON前，请逐一检查：
    1. ✓ 包含完整的9个章节对象（chapters数组长度=9）
    2. ✓ 每个章节都有 chapter_number 字段（值为1到9）
    3. ✓ 第1章存在且 chapter_number=1
    4. ✓ 第9章存在且 chapter_number=9
    5. ✓ 包含 plant_payoff_table 数组
    6. ✓ 所有花括号 { 和 } 正确配对（数量相等）
    7. ✓ 所有方括号 [ 和 ] 正确配对（数量相等）
    8. ✓ JSON可以完整解析，没有语法错误

    **⚠️ 防止提前终止的提示**
    - 如果你发现自己生成了前几章后"想停止"，请立即继续生成后续章节
    - 你的任务是生成完整的9章，不是部分章节
    - 完成所有9章之前，不要认为"任务已完成"
    - 确保JSON的最后是完整的闭合括号 }，确保整个对象被正确封闭

    **⚠️ JSON 格式强制约束（输出前必须自检）**
    1. 所有键名必须用双引号包围
    2. 不要使用单引号或尾随逗号
    3. 确保所有花括号和方括号都正确闭合
    4. 顶层字段名必须是 "chapters"（不是 "outline"）

    StorySpec: {story_spec}
    Concept: {concept}

    你需要创建9章大纲，每章包含：
    - chapter_number, title, summary
    - goals (本章目标列表)
    - conflict (本章主要冲突)
    - information_increment (本章新增的信息/认知变化)
    - emotional_increment (本章情绪变化)
    - chapter_hook (章末钩子，必须抓人)
    - plants_this_chapter (埋设的伏笔)
    - payoffs_this_chapter (回收的伏笔)
    - scenes (简略场景列表，每个场景包含scene_purpose, conflict, information_gain, emotional_shift)
    - target_words: 3000

    三幕结构：
    第一幕（第1-3章）- 建立与触发：
    - 第1章：日常破裂 + 主角欲望（提出核心缺失/渴望；埋第一层伏笔）
    - 第2章：相遇/案件引爆 + 代价（爱情相遇机制；悬疑案发/委托）
    - 第3章：第一次转折/进入新世界（主角做不可逆选择；章末强钩子）

    第二幕（第4-6章）- 对抗与加深：
    - 第4章：推进与试探（关系升温/线索扩张；埋关键误导）
    - 第5章：中点反转（真相一部分揭开/关系定性；"换一套理解"）
    - 第6章：代价升级 + 失去（分离/背叛/误会加深；重大误判）

    第三幕（第7-9章）- 崩塌与解决：
    - 第7章：全盘崩塌/最低谷（主角失去最大依靠）
    - 第8章：真相/和解的路径/最终计划（回收核心伏笔，走向对决）
    - 第9章：终局兑现主题 + 余韵（主冲突解决；主题落地；留余味）

    同时创建PlantPayoffTable（伏笔-回收表）：
    {
      "plant_payoff_table": [
        {
          "plot_element": "伏笔内容",
          "planted_chapter": 1,
          "payoff_chapter": 7,
          "payoff_type": "reveal/twist/resolution",
          "status": "planted"
        }
      ]
    }

    对于悬疑题材，还要生成TruthCard（真相卡）：
    {
      "truth_card": {
        "crime": "...",
        "perpetrator": "...",
        "motive": "...",
        "method": "...",
        "key_clues": [...],
        "red_herrings_explained": [...]
      }
    }
  expected_output: >
    严格JSON格式：
    {
      "chapters": [9个ChapterOutline对象],
      "plant_payoff_table": [PlantPayoffEntry对象数组],
      "truth_card": {...} (悬疑题材)
    }

    每章必须有明确的信息增量和情绪增量。
    章末钩子必须强有力，勾住读者。
    不要包含JSON之外的文字。
  agent: plot_architect

init_bible:
  description: >
    初始化StoryBible，吸收StorySpec、Concept和Outline的信息。

    **⚠️ 完整性要求（最高优先级 - 必须严格遵守）**
    - 必须一次性生成完整的StoryBible对象，不能中途停止或截断
    - 必须包含所有必需字段：characters, relationships, clues, timeline, chapter_summaries, genre等
    - characters数组必须包含Concept中的所有人物
    - relationships数组必须包含Concept中的所有关系
    - 绝对不能只生成部分字段就结束

    **⚠️ 输出完整性检查清单（输出JSON前必须逐项确认）**
    在输出JSON前，请逐一检查：
    1. ✓ 包含characters数组（长度>0）
    2. ✓ 包含relationships数组
    3. ✓ 包含clues对象（含planted, resolved, open三个数组）
    4. ✓ 包含timeline数组
    5. ✓ 包含chapter_summaries数组（长度为9）
    6. ✓ 包含genre字段（"romance"或"mystery"）
    7. ✓ 所有花括号 { 和 } 正确配对（数量相等）
    8. ✓ 所有方括号 [ 和 ] 正确配对（数量相等）
    9. ✓ JSON可以完整解析，没有语法错误

    **⚠️ 防止提前终止的提示**
    - 如果你发现自己生成了部分字段后"想停止"，请继续生成剩余字段
    - 你的任务是生成完整的StoryBible对象，不是部分字段
    - 确保所有数组字段都完整生成后再停止输出
    - 确保JSON的最后是完整的闭合括号 }

    **⚠️ JSON 格式强制约束（输出前必须自检）**
    1. 所有键名必须用双引号包围
    2. 不要使用单引号或尾随逗号
    3. 确保所有花括号和方括号都正确闭合

    StorySpec: {story_spec}
    Concept: {concept}
    Outline: {outline}

    创建StoryBible结构：
    - characters: 从Concept导入人物
    - relationships: 从Concept导入关系
    - clues: {planted: [], resolved: [], open: []} (悬疑)
    - timeline: []
    - chapter_summaries: []
    - immutable_facts: []
    - used_imagery: []
    - used_metaphors: []
    - genre: "romance" or "mystery"
    - truth_card: (悬疑，从Outline导入，仅限内部Agent访问)
  expected_output: >
    严格JSON格式的StoryBible对象，已初始化所有必需字段。
    不要包含JSON之外的文字。
  agent: continuity_keeper

# ==================== CHAPTER GENERATION TASKS ====================

plan_chapter:
  description: >
    为第{chapter_number}章创建详细的SceneList（场景列表）。

    **⚠️ 完整性要求（最高优先级 - 必须严格遵守）**
    - 必须一次性生成完整的6-10个场景列表，不能中途停止或截断
    - 在开始生成前，确认已理解需要输出完整的scenes数组
    - scenes数组必须包含6到10个完整的场景对象
    - 绝对不能只生成1-2个场景就结束，必须生成所有场景才能停止输出

    **⚠️ 输出完整性检查清单（输出JSON前必须逐项确认）**
    在输出JSON前，请逐一检查：
    1. ✓ 包含完整的scenes数组（数组长度在6-10之间）
    2. ✓ 每个场景都有完整的字段（scene_number, purpose, setting等）
    3. ✓ 第一个场景 scene_number=1，最后一个场景 scene_number=场景总数
    4. ✓ total_target_words = 3000
    5. ✓ 所有场景的 target_words 之和接近3000（误差±100以内）
    6. ✓ 包含 chapter_goal 和 required_emotional_arc 字段
    7. ✓ 所有花括号 { 和 } 正确配对（数量相等）
    8. ✓ 所有方括号 [ 和 ] 正确配对（数量相等）
    9. ✓ JSON可以完整解析，没有语法错误

    **⚠️ 防止提前终止的提示**
    - 如果你发现自己生成了前几个场景后"想停止"，请立即继续生成剩余场景
    - 你的任务是生成完整的6-10个场景，不是部分场景
    - 完成所有场景之前，不要认为"任务已完成"
    - 确保JSON的最后是完整的闭合括号 }

    **⚠️ JSON 格式强制约束（输出前必须自检）**
    1. 所有键名必须用双引号包围
    2. 不要使用单引号或尾随逗号
    3. 确保所有花括号和方括号都正确闭合

    当前章节：{chapter_number}
    章节大纲：{chapter_outline}
    StoryBible(public): {story_bible_public}
    StorySpec: {story_spec}

    **字数硬约束（必须自检后再输出）**
    - total_target_words 固定为 3000
    - scenes 数组中每个场景必须给出 target_words（建议 350-650）
    - scenes 内所有 target_words 之和必须等于 total_target_words（允许误差±100字以内）
      即：abs(sum(scene.target_words) - 3000) <= 100

    你需要把章纲细化为6-10个详细的场景，每个场景包含：
    - scene_number (1-10)
    - purpose (场景目的：推进事件/揭示信息/触发情绪)
    - setting (场景地点/时间)
    - characters (出场人物)
    - conflict (场景内的冲突)
    - action_beat (动作节拍)
    - dialogue_focus (对白重点)
    - information_revealed (揭示的信息)
    - emotional_shift (情绪变化)
    - plot_advancement (情节推进)
    - exit_hook (出口钩子，如何过渡到下一场)
    - target_words (字数目标，建议400-600字)
    - notes (备注)

    同时设置章节级别：
    - chapter_goal: 本章整体目标
    - required_emotional_arc: 本章情绪弧线
    - clues_to_plant: (悬疑) 本章要埋设的线索
    - clues_to_reveal: (悬疑) 本章要揭示的线索
    - plot_points_to_advance: 本章要推进的情节点

    确保场景之间有自然的过渡，节奏紧凑，不拖沓。
    每个场景都应该"三件事同时发生"：推进事件、揭示信息、触发情绪。
  expected_output: >
    严格JSON格式的SceneList对象：
    {
      "chapter_number": {chapter_number},
      "chapter_title": "...",
      "scenes": [6-10个Scene对象],
      "total_target_words": 3000,
      "chapter_goal": "...",
      "required_emotional_arc": "...",
      "clues_to_plant": [],
      "clues_to_reveal": [],
      "plot_points_to_advance": []
    }

    不要包含JSON之外的文字。
  agent: chapter_planner

write_chapter:
  description: >
    撰写第{chapter_number}章的完整正文。

    当前章节：{chapter_number}
    SceneList: {scene_list}

    # === 选择性重试支持 ===
    # 如果 {scene_list} 为空或 {scene_list_for_write} 有值（表示重试模式），
    # 优先使用 scene_list_for_write；否则使用 scene_list。
    # 注意：scene_list_for_write 是上一次 plan_chapter 生成的 SceneList 的 JSON 字符串。
    已保存场景列表（如有）：{scene_list_for_write}

    StoryBible(public): {story_bible_public}
    StorySpec: {story_spec}
    修订指令（如有）：{revision_instructions}

    输出格式要求：

    第X章：章标题
    小引：80-150字，像书摘/预告，不剧透终局
    正文：约3000字（允许2700-3300字），章末必须有钩子

    **重要 SceneList 使用规则**:
    - 如果 scene_list_for_write 非空，请使用它作为场景列表
    - 如果 scene_list_for_write 为空，使用 scene_list
    - 严格按照 SceneList 的场景顺序和场景目的写作
    - 如果两个都为空，请基于 chapter_outline 自行规划场景

    写作要求：
    1. 严格按照SceneList的场景顺序和场景目的写作
    2. 开头抓人，立即进入冲突或张力
    3. 每个场景推进事件、揭示信息、触发情绪
    4. 对白要符合人物声线（参考StoryBible中character的speech_pattern）
    5. 避免使用人物禁用短语（forbidden_phrases）
    6. 章末必须有强钩子（悬念、反转、新威胁）
    7. 字数控制在2700-3300之间

    对于悬疑题材：
    - 只能访问"本章允许揭示的信息"
    - 不能提前泄露真相
    - 线索要自然嵌入场景

    如果收到revision_instructions，针对性地重写问题段落。
  expected_output: >
    完整的章节正文，格式如下：

    第X章：[章标题]

    小引：
    [80-150字的小引]

    [约3000字的正文，包含6-10个场景，章末有钩子]

    确保字数在2700-3300之间。
  agent: chapter_writer

update_bible:
  description: >
    ⚠️⚠️⚠️ 【最高优先级】字段完整性要求 - 所有对象必须符合以下规范 ⚠️⚠️⚠️

    ========================================
    Clue 对象必须包含的字段（缺一不可）：
    ========================================
    {
      "clue_id": "clue_001",           // ✅ 必需：字符串，线索唯一标识
      "description": "线索详细描述",    // ✅ 必需：字符串，描述线索内容
      "chapter_introduced": 1,          // 必需：整数
      "is_red_herring": false,          // 可选：布尔值
      "resolved": false,                // 可选：布尔值
      "resolution_chapter": null,       // 可选：整数或null
      "importance": "major"             // 可选："major" 或 "minor"
    }

    ========================================
    TimelineEvent 对象必须包含的字段：
    ========================================
    {
      "chapter": 1,                     // ✅ 必需：整数（不能是字符串！）
      "scene": 2,                       // 可选：整数或null（不能是字符串！）
      "event": "事件描述文字",          // ✅ 必需：字符串
      "characters_involved": [...],     // 可选：数组
      "facts_established": [...],       // 可选：数组
      "emotional_shift": "..."          // 可选：字符串或null
    }

    ========================================
    🚫 绝对禁止的错误格式：
    ========================================
    ❌ Clue 缺少 description 字段
    ❌ TimelineEvent.chapter 使用字符串 "1"（必须是整数 1）
    ❌ TimelineEvent.scene 使用字符串 "plants7"（必须是整数 7）
    ❌ TimelineEvent 缺少 event 字段

    ============================================================
    【任务说明】更新StoryBible，提取第{chapter_number}章的新信息
    ============================================================

    当前章节：{chapter_number}
    前序任务已生成章节正文，请从上下文中获取。
    StoryBible(full): {story_bible_full}
    StorySpec: {story_spec}

    **⚠️ 字段类型强制约束**
    - used_imagery 和 used_metaphors 必须是 **扁平的字符串数组**
    - ❌ 错误： "used_metaphors": ["比喻1", {"type": "暗喻", "content": "内容"}]
    - ✅ 正确： "used_metaphors": ["比喻1", "比喻2", "比喻3"]
    - 每个元素只能是纯字符串，不能是对象或数组

    你需要：
    1. 提取新事实：新增的不可更改事实，加入immutable_facts
    2. 更新时间线：创建TimelineEvent对象，记录本章发生的关键事件
    3. 更新人物状态：记录人物的变化、新秘密、关系变化
    4. 提取线索（悬疑）：识别新线索，加入clues.planted；
       识别回收的线索，移至clues.resolved
    5. 生成章摘要：80-150字，概括本章关键事件和变化
    6. 追踪意象：记录本章使用的主要意象和比喻，加入used_imagery和used_metaphors

    对于悬疑题材：
    - 识别所有线索句（包含信息的细节、对话、物品等）
    - 判断是否为red_herring（误导）
    - 更新clues.planted, clues.resolved, clues.open

    返回更新后的完整StoryBible。
  expected_output: >
    严格JSON格式的更新后的StoryBible对象。
    包含更新后的characters, relationships, timeline, clues, chapter_summaries等。
    不要包含JSON之外的文字。
  agent: continuity_keeper

edit_chapter:
  description: >
    对第{chapter_number}章进行文风和节奏编辑。

    当前章节：{chapter_number}
    前序任务已生成章节正文，请从上下文中获取。
    StoryBible(public): {story_bible_public}
    StorySpec: {story_spec}
    修订指令（如有）：{revision_instructions}

    # === 选择性重试支持 ===
    # 如果 {draft_text_for_edit} 有值（表示重试模式），直接使用它作为编辑对象；
    # 否则从上下文获取 write_chapter 的输出（正常模式）。
    已保存草稿（如有）：{draft_text_for_edit}

    **重要**: draft_text_for_edit 优先级高于上下文中的 write_chapter 输出。
    如果 draft_text_for_edit 非空，请直接编辑该文本，无需从上下文查找。

    基于StyleGuide进行编辑：
    1. 统一文风：确保语气、节奏、意象密度符合StyleGuide
    2. 减少重复：删除冗余表达、重复句式
    3. 保持语言简洁直白，避免过度修饰
    4. 统一人物声线：确保对白符合character的speech_pattern
    5. 优化节奏：删除拖沓部分，加快节奏
    6. 避免重复意象：检查StoryBible.used_imagery，避免重复使用相同意象

    不要修改大结构，只做局部重写和润色。
    如果收到revision_instructions，针对性地修改指定问题。
  expected_output: >
    润色后的完整章节正文，保持原有格式：

    第X章：[章标题]

    小引：
    [润色后的小引]

    [润色后的正文，约3000字，文笔更精炼、节奏更紧凑]

    确保字数仍在2700-3300之间。
  agent: line_editor

judge_chapter:
  description: >
    对第{chapter_number}章进行质量评审，输出JSON格式的评审报告。

    **⚠️ JSON 格式强制约束（输出前必须自检）**
    1. 所有键名必须用双引号包围
    2. 不要使用单引号或尾随逗号
    3. 确保所有花括号和方括号都正确闭合

    当前章节：{chapter_number}
    前序任务已生成章节正文，请从上下文中获取。
    StoryBible(full): {story_bible_full}
    StorySpec: {story_spec}

    **⚠️ issues.type 枚举强约束（必须严格遵守）**
    issues数组中每个Issue对象的type字段只能是以下9种之一：
    "continuity", "structure", "motivation", "pacing",
    "clue_fairness", "prose", "hook", "safety", "word_count"
    ❌ 不要输出其他type（例如："ending_satisfaction"、"theme_delivery"等）
    ❌ 不要输出中文type（例如："节奏"、"人物动机"）

    评审维度（0-10分）：
    1. continuity (连续性)：是否有与StoryBible矛盾的地方
    2. pacing (节奏)：节奏是否合适，有无拖沓
    3. character_motivation (人物动机)：人物行为是否合理，动机是否清晰
    4. genre_fulfillment (类型满足度)：是否符合爱情/悬疑题材的要求
    5. prose (文笔)：文笔是否通顺、有感染力
    6. hook (钩子)：章末是否有强钩子
    7. clue_fairness (悬疑专属)：线索是否公平，读者能否合理推理

    硬性检查：
    1. safety_pass: 是否通过安全合规检查（无违规内容）
    2. continuity_conflicts: 连续性矛盾列表（如果有）
    3. word_count_in_range: 字数是否在2700-3300之间

    通过标准：
    - 爱情题材：character_motivation >= 7 AND pacing >= 7 AND hook >= 7 AND genre_fulfillment >= 7
    - 悬疑题材：上述条件 AND clue_fairness >= 7
    - 硬性：safety_pass = true AND continuity_conflicts为空 AND word_count_in_range = true

    如果不通过，必须提供：
    1. issues: 问题列表，每个问题包含type（类型）、severity（严重程度）、note（说明）
    2. revision_instructions: 可执行的修订指令列表

    输出必须是严格的JSON格式。
  expected_output: >
    严格JSON格式的JudgeReport对象：
    {
      "chapter": {chapter_number},
      "word_count": 实际字数,
      "scores": {
        "continuity": 0-10,
        "pacing": 0-10,
        "character_motivation": 0-10,
        "genre_fulfillment": 0-10,
        "prose": 0-10,
        "hook": 0-10,
        "clue_fairness": 0-10 (悬疑)
      },
      "hard_fail": {
        "safety_pass": true/false,
        "continuity_conflicts": [],
        "word_count_in_range": true/false
      },
      "passed": true/false,
      "issues": [Issue对象数组],
      "revision_instructions": ["修订指令1", "修订指令2"],
      "strengths": ["优点1", "优点2"]
    }

    不要包含JSON之外的任何文字。
  agent: critic_judge

# ==================== FINAL ASSEMBLY TASKS ====================

judge_whole_book:
  description: >
    对全书进行最终评审，检查伏笔回收、主题兑现、连续性。

    **⚠️ JSON 格式强制约束（输出前必须自检）**
    1. 所有键名必须用双引号包围
    2. 不要使用单引号或尾随逗号
    3. 确保所有花括号和方括号都正确闭合
    4. 评分字段（plant_payoff_coverage, theme_delivery, ending_satisfaction）直接填写数值，不要放在 issues 数组中

    全书正文：{book_text}
    StoryBible: {story_bible}
    StorySpec: {story_spec}

    检查项：
    1. plant_payoff_coverage: 伏笔回收率（已回收/总伏笔，要求≥95%）
    2. theme_delivery: 主题兑现度（0-10分，是否实现theme_statement）
    3. ending_satisfaction: 结局满意度（0-10分）
    4. continuity: 全书连续性扫描
    5. character_arc_consistency: 人物弧光一致性

    对于悬疑题材额外检查：
    1. clue_fairness_whole: 全书线索公平性
    2. truth_reveal_quality: 真相揭示的质量

    通过标准：
    - plant_payoff_coverage >= 0.95
    - theme_delivery >= 8
    - ending_satisfaction >= 8
    - 无连续性矛盾

    ⚠️ 重要：字段类型区分（严格遵守）
    ============================================================
    1️⃣ 评分字段（直接填写数值）：
       - plant_payoff_coverage: 浮点数（0.0-1.0）
       - theme_delivery: 整数（0-10）
       - ending_satisfaction: 整数（0-10）

    2️⃣ issues数组中的type字段（只能是以下9种之一）：
       "continuity" - 连续性问题
       "structure" - 结构问题
       "motivation" - 人物动机问题
       "pacing" - 节奏问题
       "clue_fairness" - 线索公平性问题（悬疑）
       "prose" - 文笔问题
       "hook" - 钩子问题
       "safety" - 安全合规问题
       "word_count" - 字数问题

    🚫 绝对禁止：
    - ❌ 不要把评分字段名用作issue的type值
    - ❌ issues.type不能是："ending_satisfaction", "plant_payoff_coverage", "theme_delivery"
    - ✅ 这些字段应该直接在JSON根级别填写数值，不是在issues数组中

    正确示例：
    {
      "plant_payoff_coverage": 0.95,  ← 直接填数值
      "theme_delivery": 8,             ← 直接填数值
      "ending_satisfaction": 8,         ← 直接填数值
      "issues": [
        {"type": "pacing", "severity": "medium", "note": "节奏稍慢"}  ← type只能是上面9种
      ]
    }

    如果不通过，提供targeted_patch_instructions。
  expected_output: >
    严格JSON格式：
    {
      "is_whole_book": true,
      "plant_payoff_coverage": 0.95,
      "theme_delivery": 8,
      "ending_satisfaction": 8,
      "scores": {
        "continuity": 0-10,
        "pacing": 0-10,
        "character_motivation": 0-10,
        "genre_fulfillment": 0-10,
        "prose": 0-10,
        "hook": 0-10,
        "clue_fairness": 0-10 (悬疑)
      },
      "hard_fail": {
        "safety_pass": true/false,
        "continuity_conflicts": [],
        "word_count_in_range": true/false
      },
      "passed": true/false,
      "issues": [
        {
          "type": "continuity/structure/motivation/pacing/clue_fairness/prose/hook/safety/word_count",
          "severity": "low/medium/high/critical",
          "note": "问题描述",
          "location": "章节引用（可选）"
        }
      ],
      "revision_instructions": ["修订指令1", "修订指令2"],
      "strengths": ["优点1", "优点2"]
    }

    不要包含JSON之外的文字。
  agent: critic_judge

generate_novel_metadata:
  description: >
    根据小说内容生成书名、简介和目录。

    **⚠️ JSON 格式强制约束（输出前必须自检）**
    1. 所有键名必须用双引号包围
    2. 不要使用单引号或尾随逗号
    3. 确保所有花括号和方括号都正确闭合

    StorySpec: {story_spec}
    StoryBible: {story_bible}
    章节标题列表：{chapter_titles}

    你需要生成：
    1. 书名：根据小说主题和内容创作一个吸引人的书名（2-8个字）
    2. 简介：80-150字的简介，吸引读者但不剧透结局
    3. 目录：格式化的章节标题列表

    注意：
    - 书名要有文学性和吸引力
    - 简介要简洁有力，突出核心冲突
    - 目录使用"第X章：标题"的格式
  expected_output: >
    严格JSON格式（不要包含JSON之外的文字）：
    {
      "title": "书名",
      "introduction": "简介内容（80-150字）",
      "table_of_contents": [
        "第1章：章节标题",
        "第2章：章节标题",
        "第3章：章节标题",
        "第4章：章节标题",
        "第5章：章节标题",
        "第6章：章节标题",
        "第7章：章节标题",
        "第8章：章节标题",
        "第9章：章节标题"
      ]
    }

    不要包含JSON之外的文字。
  agent: line_editor

assemble_book:
  description: >
    将9章正文组装成最终小说，添加标题、简介、目录。

    全书正文：{book_text}
    StorySpec: {story_spec}
    StoryBible: {story_bible}

    创建完整的小说文档，包含：
    1. 书名（根据主题生成）
    2. 简介（80-150字，不剧透）
    3. 目录（9章标题）
    4. 正文（9章完整内容）
  expected_output: >
    完整的小说文档，格式如下：

    # [书名]

    ## 简介
    [简介内容]

    ## 目录
    第1章 [标题]
    第2章 [标题]
    ...
    第9章 [标题]

    ## 正文

    第1章：[标题]
    [第1章完整内容]

    第2章：[标题]
    [第2章完整内容]

    ...

    第9章：[标题]
    [第9章完整内容]

    [全书完]
  agent: line_editor
